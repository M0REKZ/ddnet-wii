name: Wii build
on: [push]

env:
  DEVKITPRO: /opt/devkitpro
  DEVKITPPC: /opt/devkitpro/devkitPPC

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install devkitPPC
        run: |
          wget https://apt.devkitpro.org/install-devkitpro-pacman
          chmod +x ./install-devkitpro-pacman
          yes | sudo ./install-devkitpro-pacman
          sudo dkp-pacman -Sy
          yes "" | sudo dkp-pacman -S wii-dev

      - name: Generate
        run: |
          mkdir -p build/game/generated
          python datasrc/compile.py network_source > build/game/generated/protocol.cpp
          python datasrc/compile.py network_header > build/game/generated/protocol.h
          python datasrc/compile.py client_content_source > build/game/generated/client_data.cpp
          python datasrc/compile.py client_content_header > build/game/generated/client_data.h
          python scripts/cmd5.py src/engine/shared/protocol.h build/game/generated/protocol.h src/game/tuning.h src/game/gamecore.cpp build/game/generated/protocol.h > build/game/generated/nethash.cpp

      - name: Compile Wii build
        run: |
          make

      - name: Move into folder
        run: |
          mkdir -p apps/ddnet
          cp -r boot.dol meta.xml icon.png data apps/ddnet/

      - name: Upload .dol artifact
        uses: actions/upload-artifact@v4
        with:
          name: Wii .dol app
          path: ./apps

      - name: Upload .elf artifact
        uses: actions/upload-artifact@v4
        with:
          name: boot.elf
          path: boot.elf
